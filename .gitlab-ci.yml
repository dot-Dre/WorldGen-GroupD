stages:
  # - lint
  - build
  - test
  - deploy

variables:
  # Set the maven local repository location to speed up builds by reusing cached dependencies
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

# lint:
#   stage: lint
#   image: python:3.9
#   script:
#     # - pip install pre-commit
#     # - pre-commit run --all-files
#   tags:
#     - docker

# Build stage
build:
  stage: build
  image: maven:3.8.3-openjdk-17
  script:
    - mvn $MAVEN_OPTS clean package
  artifacts:
    paths:
      - target/DNDMapGen-0.0.1-SNAPSHOT.jar
  tags:
    - docker

# Test stage
test:
  stage: test
  image: maven:latest
  script:
    - mvn $MAVEN_OPTS test
  tags:
    - docker

# Deploy stage
deploy:
  stage: deploy
  image: openjdk:17.0.1-jdk-slim
  script:
    - mv target/DNDMapGen-0.0.1-SNAPSHOT.jar app.jar
    - java -jar -Dspring.profiles.active=production app.jar &
    - APP_PID=$!
    - sleep 10  # Adjust the time to wait before stopping the application (optional)
    - kill $APP_PID
  tags:
    - docker
  only:
    - main
